<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Layui</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="../layuiv256/css/layui.css"  media="all">
    <!-- 注意：如果你直接复制所有代码到本地，上述css路径需要改成你本地的 -->

    <script src="../layuiv256/layui.js" charset="utf-8"></script>
    <!-- 注意：如果你直接复制所有代码到本地，上述js路径需要改成你本地的 -->
</head>
<body>
<blockquote class="layui-elem-quote">
    创建试卷
</blockquote>
<form class="layui-form" action="">

    <div class="layui-form-item">
        <label class="layui-form-label">年级/科目</label>
        <div class="layui-input-inline">
            <select name="subjectSelect" id="subjectSelect" lay-filter="subjectSelect" class="layui-select">

            </select>
        </div>
    </div>

    <div  id="typePool">
        
    </div>


    <div class="layui-form-item">
        <div class="layui-input-block">
            <button class="layui-btn" lay-submit lay-filter="formDemo">立即提交</button>
            <button type="reset" class="layui-btn layui-btn-primary">重置</button>
        </div>
    </div>

</form>

<fieldset class="layui-elem-field layui-field-title" style="margin-top: 30px;">
    <legend>结果预览</legend>
</fieldset>
<div id="preview"></div>

<script>
    layui.use(['form','rate','jquery','layer','laytpl'], function(){
        var form = layui.form,
            rate = layui.rate,
            $ = layui.jquery,
            layer = layui.layer,
            laytpl = layui.laytpl;
        var parameter = {
            subjectId:"", //科目
            plateList:[] //板块集合
        };
        $.get("/querySubject",function (e) {
            var subjectList = e.data;
            if(subjectList != null){
                var options = '<option value="">请选择科目</option>';
                for(var index in subjectList){
                    options+='<option value="'+subjectList[index].subjectId+'">'+subjectList[index].subjectId+'</option>';
                }
                $("#subjectSelect").html(options);
                form.render();
            }

        });

        form.on('select(subjectSelect)',function (data) {
            layer.msg(data.value);
            //存入科目id
            parameter.subjectId = data.value;
            $.get("/queryTypePool",function (e) {
                var typePoolList = e.data;
                if(typePoolList!=null){
                    for(var index in typePoolList){
                        var difficultyArray = [{name:'难度1',number:0},{name:'难度2',number:0},{name:'难度3',number:0},{name:'难度4',number:0},{name:'难度5',number:0}];
                        //初始化总数
                        difficultyArray[0].number = typePoolList[index].amount;
                        parameter.plateList[index]={
                            plateId :typePoolList[index].plateId,
                            plateName:typePoolList[index].plateName,
                            difficultyArray:difficultyArray};
                    }
                }
                showPlate();
                form.render();
            })
        });
        function showPlate(){
            var plateList = parameter.plateList;
            var plate = '';
            for(var index1 in plateList){
                plate += '<div class="layui-form-item">'
                plate += '<label class="layui-form-label">'+plateList[index1].plateName+'</label>';
                plate += '<div class="layui-input-block">';
                for(var index2 in plateList[index1].difficultyArray){
                    plate += '<div class="layui-btn-group">' +
                        '<button type="button" class="layui-btn layui-btn-primary layui-btn-sm">'+plateList[index1].difficultyArray[index2].name+'</button>' +
                        '<button type="button" class="layui-btn layui-btn-primary layui-btn-sm" name ="addNum" value="'+ index1 + ","+index2+'"><i class="layui-icon">&#xe624;</i></button>' +
                        '<button type="button" class="layui-btn layui-btn-primary layui-btn-sm">'+plateList[index1].difficultyArray[index2].number+'</button>' +
                        '<button type="button" class="layui-btn layui-btn-primary layui-btn-sm" name ="reduceNum" value="'+ index1 + ","+index2+'"><i class="layui-icon layui-icon-subtraction"></i></button>' +
                        '</div>';
                }
                plate += '</div></div>';
            }
            $("#typePool").html(plate);
        }
        $(document).on('click','button[name="addNum"]',function () {
            var indexArray = this.value.split(",");
            parameter.plateList[indexArray[0]].difficultyArray[indexArray[1]].number++;
            showPlate();
        });
        $(document).on('click','button[name="reduceNum"]',function () {
            var indexArray = this.value.split(",");
            var num = parameter.plateList[indexArray[0]].difficultyArray[indexArray[1]].number;
            if(num >0){

                parameter.plateList[indexArray[0]].difficultyArray[indexArray[1]].number--;
            }
            showPlate();
        });

        //监听提交
        form.on('submit(formDemo)', function(data){
            $.post("/testQuestionsController/createTestQuestions",{"parameter":JSON.stringify(parameter)} ,function (e) {
                layer.msg(e.msg)

                //第三步：渲染模版
                var data = { //数据
                    "title":"试卷预览"
                    ,"list": e.data//[{"modname":"弹层","alias":"layer","site":"layer.layui.com"},{"modname":"表单","alias":"form"}]
                }
                var getTpl = demo.innerHTML
                    ,view = document.getElementById('preview');
                laytpl(getTpl).render(data, function(html){
                    view.innerHTML = html;
                });
            })
            return false;
        });

    });
</script>
<script id="demo" type="text/html">
    <h3>{{ d.title }}</h3>
    <!--<ul>-->
        {{#  layui.each(d.list, function(index, item){ }}
        {{#  layui.each(item ,function(index2,item2){  }}
        <div class="layui-row layui-col-space10">
            <div class="layui-col-md4">
                板块Id：{{ item2.typeId }}
            </div>
            <div class="layui-col-md8">
                困难等级：{{ item2.difficultyGrade }}星
            </div>
        </div>
        <div class="layui-row layui-col-space10">
            <div class="layui-col-md12">样题：{{ item2.templateContent }} </div>
        </div>
        <div class="layui-row layui-col-space10">
            <div class="layui-col-md12">答案：{{ item2.tpAnswer.answerContent }}</div>
        </div>
    <!--<li>
            <span>板块Id：{{ item2.typeId }}</span>
            <span>困难等级：{{ item2.difficultyGrade }}星</span>
        </li>
        <li>
            <span>样题：{{ item2.templateContent }}</span>
        </li>
        <li>
            <span>答案：{{ item2.tpAnswer.answerContent }}</span>
        </li>-->
        {{#  }); }}
        {{#  }); }}
        {{#  if(d.list.length === 0){ }}
        无数据
        {{#  } }}
   <!-- </ul>-->
</script>

</body>
</html>
